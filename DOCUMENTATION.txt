================================================================================
CREBIT TUITION PAYMENT APPLICATION - TECHNICAL DOCUMENTATION
================================================================================

TABLE OF CONTENTS
1. Application Overview
2. Backend Architecture (app.py)
3. Frontend Pages
4. Database Schema
5. API Endpoints
6. Webhook System
7. Payment Flow
8. Authentication & User Management

================================================================================
1. APPLICATION OVERVIEW
================================================================================

Crebit is a tuition payment platform that enables international students to send
money from their home countries (Brazil, Mexico, Colombia, etc.) to US universities
using cryptocurrency rails (USDC) for faster and cheaper transfers.

Tech Stack:
- Backend: Python Flask + Supabase
- Frontend: React + TypeScript + Tailwind CSS
- Payment Provider: UnblockPay API
- Database: Supabase (PostgreSQL)
- Authentication: Supabase Auth

Key Features:
- Multi-currency support (BRL, MXN, COP, etc.)
- Real-time exchange rate calculator
- PIX payment integration for Brazil
- SPEI payment integration for Mexico
- Automatic off-ramp to USD bank accounts
- $10 bonus on first transaction
- Transaction tracking dashboard
- Receipt generation

================================================================================
2. BACKEND ARCHITECTURE (app.py)
================================================================================

OVERVIEW:
Flask backend that handles UnblockPay API integration, webhook processing, and
database operations. Key responsibilities:
- Customer and external account creation
- Quote generation for exchange rates
- Payment processing (PIX/SPEI)
- Automatic off-ramp payouts with $10 bonus
- Webhook event handling and storage

ENVIRONMENT VARIABLES:
- UNBLOCKPAY_AUTH_TOKEN: API authentication
- UNBLOCKPAY_BASE_URL: API endpoint (sandbox/production)
- SUPABASE_URL, SUPABASE_SERVICE_KEY: Database connection
- ALLOWED_ORIGINS: CORS whitelist for frontend

<!-- DETAILED CODE SECTIONS REMOVED FOR BREVITY:
- 2.1 Imports and initialization (Flask, CORS, requests, supabase setup)
- 2.2 Environment configuration (loading env vars, conditional Supabase init)
- 2.3 CORS configuration (origins, methods, headers, credentials)
- 2.4 Health check endpoints (/, /health routes)
See git history or extended docs for full code examples -->

2.5 CORE FUNCTIONS
------------------

create_external_account(customer_id, bank_details)
- Creates US wire bank account in UnblockPay for USD payouts
- Validates required fields and truncates account_name to 34 chars
- Returns external_account_id for future transactions


create_quote(symbol, quote_type)
- Gets real-time exchange rates from UnblockPay
- Types: "on_ramp" (BRL→USDC) or "off_ramp" (USDC→USD)
- Returns quote_id and rate, valid for ~60 seconds
- Example: "BRL/USDC" on_ramp returns quotation 0.177 (1 BRL = 0.177 USDC)


create_pix_payment(amount, quote_id, customer_id)
- Creates payin transaction using Brazil's PIX system
- Returns QR code and PIX code for user to scan/enter in banking app
- Triggers webhook when payment confirmed


create_off_ramp_payout(amount, quote_id, customer_id, external_account_id)
- Converts USDC to USD and sends to user's bank account
- Checks payout history: if first payout, adds $10 bonus
- Gets wallet address, creates payout via Solana → wire transfer
- Called automatically by webhook when payin completes


save_webhook_to_database(payload, event_type, event_resource, status)
- Saves webhook events to database for transaction history
- Links webhook to user by matching customer_id
- Saves to webhook_events (primary) and transactions (legacy) tables
- Enables dashboard to display transaction history


2.6 WEBHOOK HANDLER: /webhook/unblockpay
------------------------------------------

PURPOSE: Receives UnblockPay events and automatically triggers off-ramp payouts

KEY EVENTS HANDLED:
1. payin.processing - Payment initiated, track status
2. payin.completed - Payment received, AUTOMATICALLY create off-ramp payout
3. payout.processing - Payout initiated
4. payout.completed - Money in bank account

AUTOMATIC OFF-RAMP FLOW:
payin.completed → Get customer's bank account → Create USDC→USD quote → 
Add $10 bonus (if first) → Create payout → Update status tracker

webhook_status_tracker (in-memory dict):
Tracks real-time transaction status for frontend polling


2.7 KEY API ENDPOINTS
---------------------

POST /api/create-customer
- Creates UnblockPay customer account
- Validates required fields, checks for duplicates by email
- Returns customer_id (saved to user_profiles.unblockpay_customer_id)


GET /api/user-transactions/<user_id>
- Fetches all transactions for user from webhook_events table
- Groups related payin/payout by amount ($10.20 diff) and time (5 min)
- Shows highest USD amount (payout with bonus) and most recent status
- Returns transactions array + summary (total_sent, completed, pending)

GROUPING LOGIC:
Payin: 110 BRL → 19.50 USDC + Payout: 29.50 USD = ONE transaction showing $29.50


POST /api/create-external-account - Add bank account for payouts
POST /api/create-quote - Get exchange rates
POST /api/create-pix-payment - Generate PIX QR code
POST /api/create-off-ramp-payout - Create USD payout (with $10 bonus)
POST /webhook/unblockpay - Receive UnblockPay events, trigger auto off-ramp


2.5 TRANSACTION GROUPING LOGIC
------------------------------

Purpose: Group related payin and payout transactions together

Algorithm:
1. Fetch all webhook_events for customer_id
2. Sort by created_at descending (newest first)
3. For each transaction:
   - Check if already grouped
   - Find related transactions within:
     * $10.20 amount difference (accounts for $10 bonus)
     * 5 minutes time window
   - Group matching transactions
   - Use highest USD amount for display
   - Use most recent status

Example:
- Payin: 110 BRL → 19.50 USDC (processing)
- Payout: 29.50 USD (19.50 + $10 bonus) (completed)
→ Grouped as single transaction showing $29.50 USD, status: completed

2.6 DATABASE OPERATIONS
-----------------------

Tables Used:
- user_profiles: User account information
- webhook_events: All webhook events from UnblockPay
- transactions: Processed transaction records (legacy, now using webhook_events)

Key Queries:
1. Get user's customer_id:
   SELECT unblockpay_customer_id FROM user_profiles WHERE id = user_id

2. Get user's transactions:
   SELECT * FROM webhook_events WHERE customer_id = customer_id ORDER BY created_at DESC

3. Save webhook event:
   INSERT INTO webhook_events (event_type, event_resource, customer_id, ...)

================================================================================
3. FRONTEND PAGES
================================================================================

3.1 GetStarted.tsx - Payment Flow (4 Steps)
--------------------------------------------

Step 1: Personal Info → Step 2: Bank Account → Step 3: Amount → Step 4: Payment

KEY FUNCTIONS:
- createCustomer() - Creates UnblockPay customer
- createExternalAccount() - Adds bank account for payouts
- createQuote() - Gets exchange rates
- createPixPayment() - Generates PIX QR code
- getLastCustomerId() - Retrieves customer_id from user profile (if logged in) or localStorage


3.2 SignupNew.tsx - User Registration
--------------------------------------

PURPOSE: Creates accounts in both Supabase (auth) and UnblockPay (payments)

FLOW:
1. Create Supabase auth user (email/password) → user.id
2. Create UnblockPay customer (via /api/create-customer) → customer_id
3. Save user_profiles linking user.id ↔ unblockpay_customer_id
4. Redirect to login

CRITICAL FIELD: unblockpay_customer_id
- Links auth user to payment customer
- Enables: login → retrieve customer_id → fetch transactions
- Used for all transaction queries and webhook matching


3.3 ForeignExchangeHero.tsx - Homepage Calculator
--------------------------------------------------

PURPOSE: Live exchange rate calculator showing real-time rates and comparison

KEY FEATURES:
1. Real-time rates via /api/create-quote (fetches on currency change)
2. Bidirectional input (type in either local or USD field)
3. Comparison table (Crebit vs Wise vs Flywire)
4. Mobile responsive with clamp() sizing (24px-48px fonts, responsive padding)
5. Yellow gradient CTA button → /country-selection

RATE CALCULATION:
- Fetch quote: BRL/USDC → quotation 0.177
- Display inverted: 1 / 0.177 = 5.64 BRL per USD
- User types 110 BRL → Calculate: 110 × 0.177 = 19.47 USDC

MOBILE FIXES (MEMORY[4830d12c-dd88-4486-bc5d-2764d0e9d454]):
- Headlines: clamp(24px, 7vw, 70px)
- Input fields: h-[120px] on mobile, text-2xl vs text-5xl desktop
- Calculator card: scale-[0.85] on mobile
- Swap button: 32px x 32px on mobile



================================================================================
4. DATABASE SCHEMA
================================================================================

user_profiles
├── id (UUID, primary key, references auth.users)
├── email (text)
├── first_name (text)
├── last_name (text)
├── phone (text)
├── date_of_birth (date)
├── national_id (text)
├── country (text)
├── street_address (text)
├── city (text)
├── state (text)
├── zip_code (text)
├── unblockpay_customer_id (text) ← Links to UnblockPay
├── created_at (timestamp)
└── updated_at (timestamp)

webhook_events
├── id (UUID, primary key)
├── event_type (text) ← payin.processing, payin.completed, etc.
├── event_resource (jsonb) ← Full webhook payload
├── event_resource_status (text)
├── transaction_id (text) ← UnblockPay transaction ID
├── customer_id (text) ← UnblockPay customer ID
├── user_id (UUID, nullable)
├── amount_local (numeric)
├── local_currency (text)
├── amount_usd (numeric)
├── status (text)
├── raw_payload (jsonb)
├── created_at (timestamp)
└── updated_at (timestamp)

transactions (legacy, being phased out)
├── id (UUID, primary key)
├── user_id (UUID)
├── unblockpay_transaction_id (text)
├── type (text) ← payin or payout
├── status (text)
├── amount_usd (numeric)
├── amount_local (numeric)
├── local_currency (text)
├── metadata (jsonb)
├── created_at (timestamp)
└── updated_at (timestamp)

================================================================================
5. API ENDPOINTS (See section 2.7 for details)
================================================================================

POST /api/create-customer - Create UnblockPay customer
POST /api/create-external-account - Add bank account for payouts
POST /api/create-quote - Get exchange rates
POST /api/create-pix-payment - Generate PIX QR code (Brazil)
POST /api/create-spei-payment - Generate SPEI details (Mexico)
POST /api/create-off-ramp-payout - Create USD payout with $10 bonus
GET /api/user-transactions/<user_id> - Get transaction history (grouped)
POST /webhook/unblockpay - Receive UnblockPay events, auto-trigger off-ramp
GET /health - Server health check

================================================================================
6. WEBHOOK SYSTEM
================================================================================

Webhook URL: https://www.crebitpay.com/webhook/unblockpay

Event Types Handled:
1. payin.processing - Payment initiated
2. payin.completed - Payment received, triggers automatic off-ramp
3. payout.processing - Payout initiated
4. payout.completed - Payout completed

Automatic Off-Ramp Trigger:
When payin.completed webhook received:
1. Extract customer_id from webhook
2. Get customer's external bank account
3. Create off-ramp quote (USDC → USD)
4. Add $10 bonus to amount
5. Create payout transaction
6. Save to webhook_events table

Webhook Status Tracker:
In-memory dictionary tracking transaction states:
{
  "transaction_id": {
    "payin_processing": true,
    "payin_completed": true,
    "payin_amount_brl": 110,
    "payin_amount_usdc": 19.50,
    "offramp_transaction": {
      "id": "payout_id",
      "status": "processing",
      "amount": 29.50
    },
    "offramp_completed": true
  }
}

================================================================================
7. PAYMENT FLOW (Brazil Example)
================================================================================

1. User Input → 2. Create Customer → 3. Add Bank Account → 4. Get Quote → 
5. Generate PIX QR → 6. User Pays → 7. Webhook: payin.completed → 
8. AUTO: Create Off-Ramp Payout ($10 bonus) → 9. Webhook: payout.completed → 
10. USD in Bank Account

TIMELINE: 1-5 minutes total
RESULT: User sends 110 BRL → Receives $29.50 USD (19.50 + $10 bonus)

MEXICO FLOW: Same but uses SPEI instead of PIX


================================================================================
8. AUTHENTICATION & USER MANAGEMENT
================================================================================

USER REGISTRATION: Supabase auth → UnblockPay customer → Save profile
USER LOGIN: Supabase auth → Session stored → useAuth() context

CUSTOMER ID RETRIEVAL (getLastCustomerId):
- Logged in: Get from user_profiles.unblockpay_customer_id
- Not logged in: Get from localStorage

TRANSACTION RETRIEVAL:
Get unblockpay_customer_id → Query webhook_events → Group transactions → Dashboard


================================================================================
9. KEY FEATURES & BUSINESS LOGIC
================================================================================

$10 BONUS: First transaction only, added in create_off_ramp_payout()
EXCHANGE RATE: Effective Rate = amount_local / amount_usd (e.g., 110 BRL / 19.50 = 5.64)
TRANSACTION GROUPING: Payin + payout = one transaction (highest USD, most recent status)
RECEIPT GENERATION: For completed/processing, includes logo, details, support email
REAL-TIME UPDATES: Dashboard polls every 10s, Payment page polls every 3s


================================================================================
10. ERROR HANDLING
================================================================================

1. "No customer ID found" → Create customer or login
2. "Error creating external account" → Check getLastCustomerId retrieves from user profile
3. "Failed to create quote" → UnblockPay API error, retry after delay
4. "Transaction not showing" → Verify unblockpay_customer_id in user profile
5. "Webhook not received" → Check webhook URL in UnblockPay dashboard


================================================================================
11. DEPLOYMENT & CONFIGURATION
================================================================================

ENVIRONMENT VARIABLES:
SUPABASE_URL, SUPABASE_ANON_KEY, UNBLOCKPAY_AUTH_TOKEN, FLASK_SECRET_KEY

FRONTEND: npm run build
BACKEND: python src/server/app.py

PRODUCTION URL: https://www.crebitpay.com
WEBHOOK URL: https://www.crebitpay.com/webhook/unblockpay

================================================================================
12. FUTURE IMPROVEMENTS
================================================================================

1. More countries (Colombia, Ghana, Nigeria)
2. Multiple external accounts per user
3. Transaction export (CSV/PDF)
4. Email/SMS notifications
5. Referral program
6. Multi-language support
7. Mobile app
8. Recurring payments
9. Batch payments for universities
10. Universal SumSub KYC
11. Crebit Virtual account support

================================================================================
END OF DOCUMENTATION
================================================================================

For questions or support:
Email: info@getcrebit.com

Last Updated: October 2025
Version: 1.0
